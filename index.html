<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Overflow - Opening Doors by Connecting Bed & Breakfasts</title>
  <meta name="Opening Doors by Connecting Bed & Breakfasts - A focused social network designed to grow opportunities for bed & beakfasts by connecting them to one and other." content="The HTML5 Herald">

  <!--links to include BOOTSTRAP to your project-->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/css/bootstrap.min.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  <!--links to include CSS to your project-->
  <link href="//fonts.googleapis.com/css?family=Open+Sans:300normal,300italic,400normal,400italic,600normal,600italic,700normal,700italic,800normal,800italic&amp;subset=all" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="assets/css/reset.css">
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/styles.css">

  <!--links to include EXTERNAL JS to your project-->

  <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap-modal.min.js"></script>
  <!-- <script src="assets/js/chat.js"></script> -->

  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>

  <div class="overflow-container">
    <nav class="left">

      <!-- this is the sidebar -->
      <div class="profile">
        <div class="profile-pic"></div>
        
        <div id="display-name" class="title display-name">
          <div class="fade">Logged Out</div>
        </div>
        <div id="user-settings" class="user-settings">
          <a id="log-out" class="log-out" title="Log In" href="javascript:showModal();">
            <i id="log-out-btn" class="login"></i>
            <div class="log-title">Log In</div>
          </a>
        </div>
      </div>

      <div class="side-sect favs">
        <div class="divide-title select">favourites</div><div class="divide"></div>
        <div id="selected">
          <div class="bb-line hidden">
           <div class="icon" onclick="moveButton(this)"></div>
           <div class="title">Colby House</div><div class="distance km">3</div>
         </div>

         <div class="bb-line hidden">
          <div class="icon" onclick="moveButton(this)"></div>
          <div class="title">Paradise Found</div><div class="distance km">5</div>
        </div>
      </div>
    </div>
    <div class="side-sect near">
      <div class="divide-title">users</div><div class="divide"></div>
      <div id="namesDiv"></div>
      <div class="bb-line hidden">
        <div class="icon"></div>
        <div class="title">Boot's & Sassy</div><div class="distance km">5</div>
      </div>

      <div class="bb-line hidden">
        <div class="icon"></div>
        <div class="title">Weary Gardener</div><div class="distance km">7.5</div>
      </div>
    </div>

    <div class="side-sect resp hidden">
      <div class="divide-title">responses</div><div class="divide"></div>

      <div class="response">
        <div class="icon reply"></div>
        <div class="bb-left">
          <div class="action truncate">Paradise Found responded</div>
          <div class="details">original messgae sent, 3:45pm July 23, 2015</div>
        </div>
        <div class="bb-right">
          <div class="time">4:00pm</div>
          <div class="details">respons</div>
        </div>
      </div>

      <div class="response">
        <div class="icon send"></div>
        <div class="bb-left">
          <div class="action truncate">Weary Gardener sending your way</div>
          <div class="details">original messgae sent, 3:45pm July 23, 2015</div>
        </div>
        <div class="bb-right">
          <div class="time">4:00pm</div>
          <div class="details">respons</div>
        </div>
      </div>
      
    </nav>
  </div>

  <!-- this is the chat entry area -->
  <aside>
    <div class="input-wrapper">
      <div class="text-choose">
        <a id="preset-button" title="Preset Messages" href="javascript:presetChatDisplay();">
          <div class="chevron-button"></div>
        </a>
      </div>
      <input id='messageInput' class="chat-entry" type='text' placeholder='Message' onkeyup="postChatImage()">
      <a id="chat-entry" title="Post Chat" href="javascript:postChat();">
        <div class="chat-button"></div>
      </a>
      <div id="preset-chat" class="preset-chat hidden">
        <ul>
          <li><a>Looking for a room.</a></li>
          <li><a>I have vacancies if needed.</a></li>
          <li><a>I need someone to watch the place.</a></li>
          <li><a>Sending someone your way.</a></li>
          <li><a>All booked up.</a></li>
          <li id="list-add"><a id="add"><div class='add-preset-button fa fa-plus-circle fa-2'></div>Add your own.</a></li>
        </ul>
      </div>
    </div>
  </aside>

  <!-- this is the main chat body area -->
  <section>

    <div class="chat-wrapper other hidden">
      <div class="profile-pic"></div>
      <div class="chat-body">
        <div class="title">Colby House</div>
        <div class="message"> I need someone to watch the place.</div>

        <div class="respond-wrapper">
          <div class="icon respond">
          </div><div class="text respond">respond</div>
        </div>
      </div>
    </div>

    <div class="chat-wrapper self hidden">
      <div class="profile-pic"></div>
      <div class="chat-body">
        <div class="title">A Charming Victorian</div>
        <div class="message"> Looking for a room for a guest.</div>
      </div>
      <div>
        <div class="icon reply"></div><div class="title"></div><div class="text reply"></div>
        <div class="action-buttons"></div>
      </div>
    </div>

    <div id='messagesDiv'></div>
    <div id='buffer'></div>
    

  </section>

  <!-- this is the Login Modal -->
  <div id="auth-modal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <div class="logo"></div>
          <h4 id="modal-title" class="modal-title">Authenticate</h4>
        </div>
        <div class="modal-body text-center">

          <div class="row">
            <div class="col-md-3"></div>
            <div class="col-md-3">
              <a id="twitter-signin" href="javascript:login('twitter');">
                <i id="twitter-signin-btn" class="fa fa-twitter-square fa-5x"></i>
                <p>Twitter</p>
              </a>
            </div>
            <div class="col-md-3">
              <a id="twitter-signin" href="javascript:login('facebook');">
                <i id="twitter-signin-btn" class="fa fa-facebook-square fa-5x"></i>
                <p>Facebook</p>
              </a>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>



  <script>
  var myDataRef = new Firebase('https://overflowbnb.firebaseio.com/');
  var name = "";
  var userId = "";
  var userLogged = "";
  var userNodeId = "";
  var logDate = "";
  var logged = "";
  var f = "";
  console.log(authData);
  console.log(name);
  console.log(userId);
  var authModal = $('#auth-modal').modal( {show: false });
  var gravatar = "";
  var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  var authData = myDataRef.getAuth();
  if (authData){
    userId = authData.uid;
    setUserNodeId();
    name = authData[authData.provider].displayName;
    gravatar = authData[authData.provider].profileImageURL;
    console.log('user is already logged in');
    showName();
  } else {
 // authModal.modal('show');
}


$('#messageInput').keypress(function (e) {
  if (e.keyCode == 13) {
    postChat();
  }
});


$(document).on("keypress", "#add-preset", function(e){
 if (e.keyCode == 13) {
  addPreset();
}
});


/* myDataRef.child('user').on('value', function(snapshot) {
  var allNames = snapshot.val();
  for (var u in allNames) {
    for (var i in allNames[u]) {
      //if (name) {
        //if (allNames [u] [i].id !== userId) {
          displayNamesUser(allNames [u] [i].name);
        //}
      //}
    }
  }
}); */


myDataRef.child('user').once('value', function(snapshot) {
  snapshot.forEach(function(childSnapshot) {
var allNames = childSnapshot.val();

for (var i in allNames) {
    
    userLogged = allNames [i].logged;
    displayNamesUser(allNames [i].name);

  }
  });
}); 


myDataRef.child('lastlog/' + userId).on('child_added', function(dsnapshot) {
  logUser = dsnapshot.val();
  logDate = new Date(logUser);
});


myDataRef.child('message').limitToLast(10).on('child_added', function(snapshot) {
  var message = snapshot.val();
  messageDate = new Date(message.date);

  if (message.id && userId) {
    localFormatDate(message.date);

    if (messageDate > logDate) {
      if (!f) {
        f = "first";
        $('#messagesDiv').append("<div class='post-line'>Posted since last logged in.</div>");
      }
    }

    if (message.id == userId) {
      displayChatMessageMe(message.name, message.text, message.image, dt);
    } else {
      displayChatMessageOther(message.name, message.text, message.image, dt);
    }
  }
  window.scrollTo(0,document.body.scrollHeight);
});


function showModal() {
  authModal.modal('show');
}

function login(provider) {
 myDataRef.authWithOAuthPopup(provider, function(error, authData) {

  if (error) {
    console.log("login Failed!", error);
  } else if (authData){
    console.log("Authenticated successfully with payload:", authData);
    userId = authData.uid;

    name = authData[authData.provider].displayName;
    gravatar = authData[authData.provider].profileImageURL;
    logged = "yes"
    console.log(name);
    showName();
    authModal.modal('hide');
    console.log("User " + userId + " is logged in with " + authData.provider);

    myDataRef.child('user').child(userId).once("value", function(snapshot) {
  var ifExists = snapshot.exists(); //a firebase function
  if (ifExists){
    console.log('user is already in the system');
//setUserNodeId();
data = snapshot.val();
for (key in data) {
  userNodeId = key;
  console.log('user node is 1 ' + userNodeId);
}
if (userNodeId) {
  myDataRef.child('user').child(userId).child(userNodeId).update({logged:logged});
}
} else {
  myDataRef.child('user').child(userId).push({id:userId, name:name, image:gravatar, logged:logged});
  setUserNodeId();
}
});
  }
});
}


function setUserNodeId() {
  myDataRef.child('user').child(userId).once("value", function(snapshot) {
    data = snapshot.val();
    for (key in data) {
      userNodeId = key;
    }
  }); 
}


function logout() {
  lastLog();
  logged = "";
  if (userNodeId) {
    myDataRef.child('user').child(userId).child(userNodeId).update({logged:logged});
  }
  myDataRef.unauth();
  name = "";
  id = "";
  location.reload();
}


function showName() {
  $('.profile-pic').css('background-image', 'url(' + gravatar + ')');

  $("#display-name").html("<div>" + name + "</div><div class='status no-vacancy' onclick='toggleStatus()'>No Vacancy</div>");

  $("#user-settings").html("<a id='log-out' class='log-out' title='Log Out' href='javascript:logout();'> \
   <i id='log-out-btn' class='logout'></i><div class='log-title'>Log Out</div></a>");
}


function toggleStatus() {
 $(".status").toggleClass( "no-vacancy" );
 if ($(".status").hasClass( "no-vacancy" )) {
  $(".status").html("No Vacancy");
} else {
  $(".status").html("Vacancy");
}
}


function postChat() {
  //check to see if the user is logged in
  if (!name) {
    authModal.modal('show');
  } else {
    var text = $('#messageInput').val();
    if (text != "") {

      var d = new Date();
      var dt = d.toString();

      myDataRef.child('message').push({id: userId, name: name, text: text, image: gravatar, date: dt});
      $('#messageInput').val('');
      $('.chat-button').removeClass('select');
    } else {
      $('#messageInput').attr("placeholder", "Please enter a Message.");
      setTimeout(changeBack,4000);
    }
  }
}


function presetChatDisplay() {
  $( ".preset-chat" ).toggleClass( "hidden" );
  $( ".chevron-button" ).toggleClass( "select" );
  changePresetMenu();
}


$(document).on("click", ".remove-preset-button", function(){
 $(this).parent('li').remove();
});

$(document).on('click', '#preset-chat a' , function(e) {

  var txt = $(e.target).text();
  var id = $(this).attr('id'); 
  if (id == "add") {


    $("#add").html("<div class='add-preset-button fa fa-plus-circle fa-2' onclick='addPreset()'></div><input id='add-preset' type='text' placeholder=''>");
    $("#add").removeAttr('id');
    $(this).attr('id', 'new-preset')

  } else if (id == "new-preset") {

  } else {
    var txt = $(e.target).text();
    $('#messageInput').val(txt);
    presetChatDisplay();
    postChatImage();
    postChat();
  }
});


function listPreset (txtpreset) {
 var txt = txtpreset
 $("#list-add").before("<li><a>" + txtpreset + "</a><div class='remove-preset-button fa fa-minus-circle fa-2'></div></li>");
}


function addPreset() {
  var npreset = $('#add-preset').val();
  if (npreset != "") {
      // add it to presets
      listPreset (npreset);
      changePresetMenu();

    } else {

      $('#add-preset').attr("placeholder", "Type message and hit ENTER");
      setTimeout(changePresetBack,4000);
    }
  }

  function changePresetMenu() {
    $("#list-add").html("<a id='add'><div class='add-preset-button fa fa-plus-circle fa-2'></div>Add your own.</a>");
  }


  function minusPreset() {
    $(this).parents('.li').remove();
  }


  function changeBack() {
    $('#messageInput').attr("placeholder", "Message");
  }


  function changePresetBack() {
    $('#add-preset').attr("placeholder", "");
  }


  function postChatImage(){
    if ($('.chat-entry').filter(function(){return $(this).val() != '';}).length) {
     $('.chat-button').addClass('select');
   } else {
    $('.chat-button').removeClass('select');
  }
}


function displayNamesUser(userName) {
 if (userLogged) {

  $('#namesDiv').append (
    "<div class='bb-line'> \
    <div class='icon'  onclick='moveUser(this)'></div> \
    <div class='title'>" + userName + "</div> \
    </div>"
    );

} else {

  $('#namesDiv').append (
    "<div class='bb-line'> \
    <div class='icon'  onclick='moveUser(this)'></div> \
    <div class='title fade'>" + userName + "</div> \
    </div>"
    );
}
}


function lastLog() {
  ld = new Date();
  ldt = ld.toString();

  myDataRef.child('lastlog').child(userId).update({logout:ldt});
}


/* function addFavourite() {
myDataRef.child('favourites').child(userId).once("value", function(snapshot) {
var ifExists = snapshot.exists(); //a firebase function

if (ifExists){
//just add preperties to favourites/userId
DataRef.child('favourites/' + userId).push({id:'userId2', name:'userName'});
console.log('favourites is already in the system');

} else {

// add favourites and userId   
myDataRef.child('favourites').child(userId).push({id:'userId', name:'userName'});
}
})  
} */


function moveUser(elem){
  if( $(elem).parent().parent().attr("id") == "namesDiv" ){
    $(elem).parent().detach().appendTo('#selected');
  }
  else{
    $(elem).parent().detach().appendTo('#namesDiv'); 
  }
}


function displayChatMessageMe(name, text, image, date) {
  $('#messagesDiv').append ( 
    "<div class='chat-wrapper self'> \
    <div class='profile-pic'></div> \
    <div class='chat-body'> \
    <div class='title'>" + name + "</div><div class='date'>" + date + "</div> \
    <div class='message'>" + text + "</div>" 
    // <div class='respond-wrapper'> \
    // <div class='icon respond'></div> \
    // <div class='text respond'>respond</div></div></div></div>"
    );
  $('.self .profile-pic').css('background-image', 'url(' + image + ')');
}


function displayChatMessageOther(name, text, image, date) {
  $('#messagesDiv').append ( 
    "<div class='chat-wrapper other'> \
    <div class='profile-pic' style='background-image: url(" + image + ");'></div> \
    <div class='chat-body'> \
    <div class='title'>" + name + "</div><div class='date'>" + date + "</div> \
    <div class='message'>" + text + "</div>" 
    // <div class='respond-wrapper'> \
    // <div class='icon respond'></div> \
    // <div class='text respond'>respond</div></div></div></div>"
    );
  //$('.other .profile-pic').css('background-image', 'url(' + image + ')');
}


function localFormatDate(d) {
  var d = new Date(d);
  var day = days[d.getDay()];
  var hr = d.getHours();
  if (hr == 0) {
    hr = 12;
  } else if (hr > 12) {
    hr = hr - 12;
  }
  var min = d.getMinutes();
  if (min < 10) {
    min = "0" + min;
  }
  var ampm = (hr < 12) ? "am" : "pm";
  var date = d.getDate();
  var month = months[d.getMonth()];
  var year = d.getFullYear();
  dt = hr + ":" + min + ampm + " | " + day + ", " + date + " " + month;
}

</script>

</body>
</html>